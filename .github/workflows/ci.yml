name: CI-CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  IMAGE_NAME: odoo-aerocompliance

permissions:
  contents: read
  packages: write

jobs:
  # ============================
  # 1) CI : Lint + Test + SonarQube + Security + Build + Scan + Push
  # ============================
  ci-build-scan:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout repo
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2. Setup Python
      # -----------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # -----------------------------
      # 3. Install Dev Dependencies
      # -----------------------------
      - name: Install dev dependencies
        run: |
          pip install -r requirements-dev.txt

      # -----------------------------
      # 4. Linting (Black + Ruff)
      # -----------------------------
      - name: Run Black (check)
        run: black --check .

      - name: Run Ruff
        run: ruff check .

      # -----------------------------
      # 5. Run Tests (pytest)
      # -----------------------------
      - name: Run Tests
        run: pytest || echo "No tests yet"

      # -----------------------------
      # 6. SonarQube Scan (NEW)
      # -----------------------------
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2
        with:
          args: >
            -Dsonar.projectKey=odoo-aerocompliance
            -Dsonar.projectName=odoo-aerocompliance
            -Dsonar.sources=addons/aero_compliance
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      # -----------------------------
      # 7. Install Semgrep
      # -----------------------------
      - name: Install Semgrep
        run: pip install semgrep

      # -----------------------------
      # 8. Semgrep SAST
      # -----------------------------
      - name: Run Semgrep scan
        run: semgrep --config auto .
        continue-on-error: true

      # -----------------------------
      # 9. Trivy FS Scan
      # -----------------------------
      - name: Run Trivy FS Scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          scan-ref: .
          ignore-unfixed: true
          severity: HIGH,CRITICAL
        continue-on-error: true

      # -----------------------------
      # 10. Login to GitHub Container Registry
      # -----------------------------
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------
      # 11. Set IMAGE_TAG
      # -----------------------------
      - name: Set image tag
        run: |
          IMAGE_TAG=ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      # -----------------------------
      # 12. Build Docker image
      # -----------------------------
      - name: Build Docker image
        run: docker build -t $IMAGE_TAG .

      # -----------------------------
      # 13. Push Docker image
      # -----------------------------
      - name: Push Docker image
        run: docker push $IMAGE_TAG

      # -----------------------------
      # 14. Install Trivy CLI
      # -----------------------------
      - name: Install Trivy CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      # -----------------------------
      # 15. Trivy Scan Image
      # -----------------------------
      - name: Run Trivy Image Scan
        run: trivy image --severity HIGH,CRITICAL --ignore-unfixed $IMAGE_TAG
        continue-on-error: true

  # ============================
  # 2) CD : Deploy (désactivé)
  # ============================
  cd-deploy:
    if: false
    runs-on: ubuntu-latest
    needs: ci-build-scan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_DATA }}" > ~/.kube/config

      - name: Set IMAGE_TAG
        run: |
          IMAGE_TAG=ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Apply Kubernetes manifests
        run: kubectl apply -f k8s/

      - name: Update Odoo deployment
        run: kubectl set image deployment/odoo-deployment odoo-container=$IMAGE_TAG --record

      - name: Check rollout status
        run: kubectl rollout status deployment/odoo-deployment
